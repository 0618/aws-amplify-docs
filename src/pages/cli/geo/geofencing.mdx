export const meta = {
  title: `Geofencing`,
  description: `Use Amplify CLI to create and manage collections of Geofences`,
};

A Geofence is a virtual perimeter for a real-world geographic area. A Geofence contains points or vertices that form a closed boundary, defining an area of interest. 
Geofence collections store one or multiple Geofences.
Amplify's `geo` category enables you to create and manage Geofence collections used to setup virtual geographic perimeters.

<Callout>

**Note:** The version of Amplify CLI should be `7.6.8-geo.0` or later. You can check the version using `amplify -v`. Use  `npm i -g @aws-amplify/cli` to upgrade.

</Callout>

## Setup a new Geofence Collection

You can setup a new Geofence Collection using:
```bash
amplify add geo
```
```console
? Select which capability you want to add: 
  Map (visualize the geospatial data) 
  Location search (search by places, addresses, coordinates) 
❯ Geofencing (visualize virtual perimeters)
```

If you haven't yet added `auth` to your project, you will be directed to do so at this stage. You can choose the defaults to get started or follow the [auth configuration document](/cli/auth/overview) for advanced setup.

Next, set a name for the Geofence Collection, for example: 

```console
? Provide a name for the Geofence Collection: storesInWashington
```

## Geofence Collection Access permissions
If you do not yet have a Cognito user pool group added to your project, you will be directed to add it at this stage.


Cognito user pool groups are necessary to manage access to your Geofence Collection. Only Authorized users who are part of the Cognito group can perform CRUD operations granted to the group.


To configure the access permissions for your Geofence Collection resource,

```console
? Select one or more cognito groups to give access:
✔ storesInWashingtonGeofenceCollectionAdmin

? What kind of access do you want for storesInWashingtonGeofenceCollectionAdmin users? Select ALL that apply:
 ✔ Read geofence
 ✔ Create/Update geofence
   Delete geofence
 ✔ List geofences
```

<Callout>

**Note:** These permissions apply to ALL Geofences in a collection. For example, If you chose `Read geofence` permission for say `storesInWashingtonGeofenceCollectionAdmin`
Cognito group, ALL users added to that group will be able to read the properties of ALL Geofences in that Geofence collection.

</Callout>


## Geofence Collection Pricing Plan

The pricing plan for the Geofence Collection is `RequestBasedUsage` by default.

The pricing plan for the Geofence Collection will be set to `RequestBasedUsage`.
We advice you to go through the [location service pricing](https://aws.amazon.com/location/pricing/) along with the [location service terms](https://aws.amazon.com/service-terms/) (_82.5 section_) to learn more about the pricing plan.

## Set a default Geofence Collection
If you added more than one geofence collection via `amplify add geo`, the geofence collection that was added last will be the default. 
However, you can opt out of setting the current geofence collection as the default:

```console
? Set this geofence collection as the default? It will be used in Amplify geofence collection API calls if no explicit reference is provided. (Y/n)
> No
```
Answering `No` will retain the previously set default.

## Display Geofences on a Map
To display the Geofences on a Map in your application, you will need a configured Map resource in your project.
You can follow [these steps](/cli/geo/maps) to configure a Map resource. 

Additionally, you need to make sure that the Map resource has access to the relevant Cognito user pool groups. Follow [these steps](/cli/geo/maps/#map-access-permissions) to do that.


> Note: Make sure to run `amplify push` to provision your resources in the AWS backend.

That's it! You can now create virtual perimeters around points of interest in your application. Follow the library documentation as listed [here](/lib/geo/geofences).


## Adding users to a Cognito User Pool Group
In order to add users to an existing Cognito user pool group created using Amplify CLI, follow the steps mentioned below:

#### Using the AWS SDK for Javascript
To add users to an existing Cognito user pool group programmatically, you can use the AWS SDK for Javascript. Refer to the [API documentation](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/CognitoIdentityServiceProvider.html#adminAddUserToGroup).

#### Using the AWS console
Open the AWS console page corresponding to the Cognito user pool that is provisioned by Amplify CLI using
```console
amplify auth console

? Which console 
❯ User Pool 
  Identity Pool 
  User Pool and Identity Pool
```

From the Cognito user pool console page that is opened in your default browser, choose `Users and groups` tab in `General settings`.
Then, choose the corresponding Cognito group from the `Groups` tab on the right as shown 
![cognito user pool console groups tab](/images/cli/geo/geo-cognito-groups-1.png)

Then click on the `Add users` button that displays a window to select the users by their `username`, `email` etc. that you intend to add to the Cognito user pool group.
![cognito group add users button](/images/cli/geo/geo-cognito-groups-2.png)


## Upload your own GeoJSON file to geofence collection
After you have added geofence collection and provisioned the resource, you will be able to upload your own GeoJSON file that defines the Geofences in a collection via the command: 
```bash
amplify geo populate
```
You can refer to [GeoJSON.IO](https://geojson.io/) where you can draw your own geofences and have GeoJSON file auto generated. After you get the GeoJSON file, you can provide the file path:
```console
? Provide the path to GeoJSON file containing the Geofences for ${your_geofence_collection} collection:
> ${your_input_geojson_file_path}
```
For each geofence feature, it requires a unique identifier. According to the [RFC7946](https://datatracker.ietf.org/doc/html/rfc7946#section-3.2), There are two options for applying identifiers:

### Root level ID

This option will use auto-generated `id` field in the root level of Feature object as identifier.
<Callout>

**Note:** This option will UPDATE your GeoJSON file

</Callout>

```console
? Do you have an identifier field in the Geofence(Feature) properties?
> No I will use the root level "id" field on Feature type. Auto-Assign if missing (this will UPDATE the GeoJSON file)
```

### Custom properties

This option allows you to choose your own fields inside `properties` of Feature object. The identifier field should have unique values among geofences.
```console
? Do you have an identifier field in the Geofence(Feature) properties?
> Yes I want to use one of the Geofence(Feature) properties as an identifier
? Provide the name of the property to use as a unique geofence identifier. Do not use Personal Identifiable Information such as email, username etc:
> ${your_input_for_unique_identifier}
```

A validation of the GeoJSON file will be executed afterwards. The upload of geofences will be triggered upon the success of validation. For the regulation of GeoJSON, please refer to [RFC7946](https://datatracker.ietf.org/doc/html/rfc7946)
```console
✅ Successfully validated GeoJSON file.
✅ Successfully added/updated Geofences in your collection
```

<Callout>

**Note:** After you have provisioned the Geofence Collection using Amplify CLI, depending on your application's use-case, you can also add Geofences to
the provisioned Geofence Collection programmatically. Refer this [API documentation](/lib/geo/geofences#savegeofences) for more information.

</Callout>
