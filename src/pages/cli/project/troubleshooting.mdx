export const meta = {
  title: `Troubleshooting Guide`,
  description: `Information to troubleshoot common Amplify CLI project errors.`,
};

This troubleshooting guide provides guidance to developers to detect and correct common errors encountered during development, deployment, and migration of apps built using the Amplify CLI.

## Essential Reading

### Amplify CLI Project 
To debug deployment issues, it's helpful to understand the [file structure of your Amplify-generated project](https://docs.amplify.aws/cli/reference/files/) and the artifacts generated by the Amplify CLI.
1. Amplify CloudFormation artifacts: The Amplify CLI provisions AWS resources using [CloudFormation templates](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html) using input parameters provided by the CLI walkthrough. Starting with Amplify CLI version 7 and above, some categories (Storage, Auth, API) allow developers to override the Amplify-generated AWS resource configurations with the [Amplify CLI Overrides feature](https://docs.amplify.aws/cli/project/override/).
1. Amplify CLI input parameters artifacts: All user provided inputs are stored in JSON files in the `/amplify/backend` folder. For example, `cli-inputs.json` or `amplify-meta.json`. These files let you inspect the configurations, both developer-provided and Amplify-generated, to root cause potential problems. Refer to [Amplify Backend Files](https://docs.amplify.aws/cli/reference/files/#backend-configjson) to determine if a file is safe to edit manually.

### Amplify GraphQL API
Resolving deployment issues in Amplify projects with a GraphQL API:

#### Understanding Amplify GraphQL artifacts:

The Amplify CLI GraphQL workflow helps generate AWS AppSync infrastructure resources (API definitions, schema, resolvers) and client-side code. Running `amplify api gql-compile` and [amplify codegen](https://docs.amplify.aws/cli/graphql/client-code-generation/) prior to running `amplify push` may help developers to validate their GraphQL schemas and avoid getting `amplify push` failures. Please refer to the [Amplify GraphQL Troubleshooting guide](https://docs.amplify.aws/cli/graphql/troubleshooting/).
  * GraphQL schema VTL generation: The Amplify CLI GraphQL workflow uses the [AWS AppSync service](https://docs.aws.amazon.com/appsync/latest/devguide/system-overview-and-architecture.html) to provision the GraphQL API. The “amplify api gql-compile” command transpiles the GraphQL schema provided by the developer and generates all the artifacts required to deploy the API in AWS. 
    +	Directives like [@model](https://docs.amplify.aws/cli/graphql/data-modeling/), [@function](https://docs.amplify.aws/cli-legacy/graphql-transformer/function/), [@auth](https://docs.amplify.aws/cli-legacy/graphql-transformer/auth/#auth), and [@searchable](https://docs.amplify.aws/cli-legacy/graphql-transformer/searchable/#definition) in the GraphQL schema are used to generate CloudFormation and provision AWS resources.
    +	The GraphQL resolvers for Query, Mutation or Subscription are converted into [VTL (Velocity Template Language)](https://docs.aws.amazon.com/appsync/latest/devguide/resolver-mapping-template-reference-programming-guide.html) files. AWS AppSync uses VTL to translate GraphQL requests from clients into a request to your data source.

  * GraphQL schema client-side code generation: The Amplify CLI GraphQL workflow allows developers to generate client side code for web and mobile clients using the `amplify codegen` command. 

## Troubleshooting "amplify push" failures
<Callout information>
Error Messages: “An error occurred during the push operation”
</Callout>

The [`amplify push`](https://docs.amplify.aws/cli/start/workflows/#amplify-push) command performs the following steps:

1. It generates CloudFormation for deployment of resources to AWS.
1. When building a GraphQL API, the CLI runs `amplify api gql-compile` internally to compile the schema and generate VTL (Velocity Templates) for mapping resolvers and CloudFormation templates to allocate AWS resources. 
1. It builds, packages, and uploads the deployment artifacts into the application's deployment bucket. 
1. It uses the AWS CloudFormation SDK to deploy the CloudFormation stack into your AWS account.
1. On a successful deployment of the resources to AWS, the Amplify CLI renames the deployment package in the deployment bucket to `#current-cloud-backend.zip`. This file is the source of truth for your deployment.
1. If your local project is deleted or corrupted, you can always go back to your last successful deployment using [`amplify pull`](https://docs.amplify.aws/cli/start/workflows/#amplify-pull).

![Amplify folders created in the deployment bucket](/images/ts-guide-amplify-deployment-folders.png)

The following section shows some examples on how to debug `amplify push` failures: 

### Push failures from manual changes to cloud resources - Drift 
<Callout warning>

**Warning:** Once an application is deployed to the cloud using Amplify CLI the cloud resources like DynamoDB tables, Cognito Roles, IAM policies must never be updated manually. 

</Callout>

The Amplify CLI cannot track manual changes applied to deployed resources. This state is called “CloudFormation drift” and may cause subsequent deployments to fail. Currently there is no automated way to fix CloudFormation drift. Each resource must be inspected through the AWS console for drift in its CloudFormation stack and the drift has to be resolved manually.
Assume, you have created a GraphQL schema in Amplify with multiple models which results in the creation of AppSync API models, resolvers and multiple DynamoDB tables and GSIs. 

#### Scenario 1: `amplify push` fails after manually updating DynamoDB tables and GSIs.
Assume you have renamed GraphQL [@model](https://docs.amplify.aws/cli/graphql/data-modeling/)s in your Amplify CLI project and updated their [@index](https://docs.amplify.aws/cli/graphql/data-modeling/) parameters. 
However, at this point you use the DynamoDB console in your account to delete multiple [GSIs](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GSI.html) belonging to the Amplify application which belonged to the older model names. 
This action will introduce drift in the CloudFormation stack deployed by Amplify. Since the GSIs corresponding to the older DynamoDB tables are deleted, any change to index parameters will fail during deployment. 

##### Suggested Resolution:
To fix deployment failures due to drift, manually rollback the state of the drifted resource to match its state in CloudFormation. Then retry `amplify push`. 
1. You can view the drift in the DynamoDB CloudFormation Stack per instructions in the [AWS Drift Detection document](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/detect-drift-stack.html)
1. Revert every drift manually through the AWS console. In this particular scenario, re-create the GSIs and manually undo any renaming changes.
1. Perform an `amplify push`.

#### Scenario 2: `amplify push` fails after manually updating (non database) resources in the cloud.

* You have manually updated your GraphQL schema using the AppSync console. Or
* You have manually deleted user pools from the Cognito console. Or
* You have updated the code in Lambda functions which were originally deployed through Amplify.

##### Suggested Resolution: 
These types of drift must be addressed on a case-by-case basis. In some cases, such as a Lambda code change, forcing a redeployment of the function by making a minor change to the code may work. In other cases, like deleting user pools or updates to GraphQL schema from the AppSync console, try the following steps:
1. Forcible deployment of CloudFormation stack from the CLI - Run `amplify push --force` to force push the application’s resource stack to be deployed.
1. Forcible deployment of CloudFormation stack from the Console - Fetch the CloudFormation stack from the application’s deployment bucket and selectively run the resource specific part of the stack through the CloudFormation console.
1. Apply drift changes into code: If both the above methods to deploy CloudFormation have failed for you, the other option is to inspect the manual changes and to update them in the CLI input files. For example, you could update the GraphQL schema to reflect the same changes as performed manually in the cloud.

### Push failures in a multi-account multi-environment project (CI/CD errors)
In a multi-account project with CI/CD, some causes for an application deploying correctly in one environment but failing in another environment are:
1. Some resource being referenced in the CloudFormation is missing from the failing account. 
1. The failing account has no permission to access a particular resource used in the CloudFormation. 
1. The application code relies on “secrets” and secrets are not correctly created or copied in the failing environment.

#### Scenario 1: Amplify push fails in one account/environment
Assume, you have created a project in a “Demo” account and are planning to expand it to a full CI/CD pipeline with Dev, Test and Prod environments, your project most probably follows a pattern specified in the [Amplify Teams guide](https://docs.amplify.aws/cli/teams/overview/#setting-up-prod-and-dev-environments). However on completion of all steps you observe that Amplify studio displays the “build” step of one of your stages as failed and others as successfully deployed.

##### Suggested Resolution: 
To debug any issues related to secrets not being correctly copied across environments, refer to [Multi-environment flows](https://docs.amplify.aws/cli/function/secrets/#multi-environment-flows) section in the [Access secret values](https://docs.amplify.aws/cli/function/secrets) documentation. 
For debugging other problems, using Amplify CLI deploy the application in the failing account.
1. `amplify pull --appId successfulEnvAppID --envName successfulEnv`
1. `amplify env checkout failingEnv`
1. `amplify push` 

If the push fails, check the CloudFormation event logs for the failing resource to get detailed information and use this to fix issues in the environment. Visit the CloudFormation service console and search for you application name. An application named "myProject" deployed in a "beta" environment would have a CloudFormation stack named amplify-myProject-beta-{random chars}. Click on the stack name and the Resources tab to view the status and the error reason.
This figure displays the CloudFormation status logs for a deployment failure of a resource:

![Cloudformation stack deployment error](/images/ts-guide-cfn-error.png)

### Push failures from resources exceeding AWS service quotas
<Callout information>
Error Messages: 

"Limit on the number of resources in a single stack operation exceeded”  
"Cannot exceed quota for PoliciesPerRole"
</Callout>

AWS maintains [service quotas](https://docs.aws.amazon.com/general/latest/gr/aws-service-information.html) for various AWS services. If your application contains many resources, such as large GraphQL schemas or REST APIs with many resolvers, you may hit a service limit.
To identify if a push failure is because of exceeding [AWS Service level quotas](https://docs.aws.amazon.com/general/latest/gr/aws-service-information.html) check the AWS console for the CloudFormation deployment/failure logs.

##### Suggested Resolution: 
1. If the bug is related to hitting service-quotas, you can use [AWS Service Quotas console](https://console.aws.amazon.com/servicequotas) to view and request increases for most AWS quotas.
1. If your application uses Amplify DataStore, some resource limits may affect deployment. Refer to [Amplify DataStore Best Practices](https://docs.aws.amazon.com/whitepapers/latest/amplify-datastore-implementation/amplify-datastore-best-practices.html) for insights into making the correct design decisions to help resolve these types of issues. 
1. If the service quotas cannot be increased, then this may require you to redesign some aspects of your application for sustainable running in a serverless environment. Referring to [AWS Knowledge Center](https://aws.amazon.com/premiumsupport/knowledge-center/) may help understand the different prescribed design changes. For example, a complex GraphQL schema could be simplified to reduce the number of GraphQL resources in use e.g collapsing models, composite keys, Lambda resolvers. Using escape hatches like overrides and export may help to scale the application beyond the CLI generated architecture. 

#### Scenario 1: Optimizing REST API schema for reducing policy count:
Assume you have deployed a REST API using Amplify CLI with 3 routes and one Lambda to handle all routes. 
Amplify CLI in this case generates one policy per route and applies it to the Lambda execution role. A configuration with 20 or more routes may hit the “Max policies per role” limit per [AWS IAM limits](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_iam-limits.html).

|Resources	|Policies|	Role|	Handler|
|-|-|-|-|
|/items/rock|	amplify generated policy1	| | |
|/items/paper| amplify generated policy2 |Execution Role Lambda| Lambda function |
|/items/scissors|	amplify generated policy3 || |		

However, if your application has many routes, one way to reduce the number of policies generated is creating a single resource with parameterization of the paths:
`/items?item=rock, /items?item=paper, /items?item=scissors` 
In this case the Amplify CLI creates only 1 policy for the /items resource.

|Resources	|Policies|	Role|	Handler|
|-|-|-|-|
|/items| amplify generated policy	| Execution Role Lambda | Lambda function |

### Push failures from GraphQL schema syntax errors
Tag: “Schema validation failed”, “Unknown directive”, “invalid directive”
After making any GraphQL schema changes, run `amplify api gql-compile` to ensure that the schema is correctly formed and amplify is able to generate valid CloudFormation from the GraphQL schema. Refer to the [Amplify CLI GraphQL Documentation](https://docs.amplify.aws/cli-legacy/graphql-transformer/overview/) to understand the latest Amplify GraphQL directives.

#### Scenario 1: GraphQL Schema errors

Assume your GraphQL schema has an error where the directive @model is misspelled as @mode:
```graphql
type Tag @mode { /** @mode is an invalid directive **/
  id : ID!
  tag: String
  topics: [Topic]
}
```

When running `amplify api gql-compile` the transform step will fail with an invalid directive error. 

![Amplify GraphQL schema validation error](/images/ts-guide-gql-schema-validation-error.png)

### Troubleshooting other GraphQL schema related errors 
If `amplify push` fails while deploying any of the scenarios below, refer to the [Amplify GraphQL Troubleshooting Guide](https://docs.amplify.aws/cli/graphql/troubleshooting/).
1.	[Deploying multiple index changes in a single `amplify push`](https://docs.amplify.aws/cli/graphql/troubleshooting/#deploying-multiple-index-changes-at-once)
1.	[Backfill OpenSearch index from DynamoDB table](https://docs.amplify.aws/cli/graphql/troubleshooting/#deploying-multiple-index-changes-at-once)
1.	[Index with Multi-Sort Key Fields](https://docs.amplify.aws/cli/graphql/troubleshooting/#index-with-multiple-sort-key-fields)

## Deployment Best Practices
Practices which help developers avoid deployment errors and scaling problems.

### Overriding Amplify CLI Behavior 
The Amplify CLI follows a unidirectional data flow. Any changes to your application must be performed only through the Amplify CLI and the associated configuration files or through Amplify Studio. Never manually edit any resources directly from the AWS console or using the AWS CLI/SDK, unless the Amplify documentation explains that it’s necessary to achieve something. To override the default behavior of Amplify CLI generated resources, you should follow the instructions in the [Amplify extensibility documentation](https://docs.amplify.aws/cli/#extensibility) which details all the “escape hatches” available in the Amplify CLI framework. 

### Changing Model Names in the GraphQL Schema
<Callout information>
Error Messages: 

“An error occurred during the push operation: Removing a model from the GraphQL schema will also remove the underlying DynamoDB table” 
“ALL EXISTING DATA IN THESE TABLES WILL BE LOST!”
</Callout>

If you've previously pushed the schema to the cloud and then rename the table in the schema, then the subsequent push will fail and require you to pass `—allow-destructive-graphql-schema-updates`. This flag will result in the deletion of the backing DynamoDB  table for the old model and subsequent creation of the tables with the new model names. 

#### Scenario 1: Error displayed when GraphQL schema change results in deletion of DynamoDB tables. 

![Amplify GraphQL model deletion warning](/images/ts-guide-model-deletion-warning.png)

### Migration from GraphQL Transformer V1 to GraphQL Transformer V2
If you have previously deployed an application using GraphQL Transformer V1 and have decided to migrate to GraphQL transformer V2, go through the [GraphQL Transformer migration document](https://docs.amplify.aws/cli/migration/transformer-migration/#changes-that-amplify-cli-will-auto-migrate-for-you) to understand the impact of the migration on the schema directives and limitations prior to updating. You can confirm the version of the GraphQL transformer using the `amplify status` command. You can also inspect the `transformerversion` feature flag in `${project-root}/amplify/cli.json`, to confirm.

### Local Testing 
Test schema changes and business logic as much as you can prior to deployment. The `amplify mock` command allows validation of your cloud dependencies locally. Follow the mock testing examples in [Advanced Workflows document](https://docs.amplify.aws/cli/usage/mock/) to dive deeper.

## Further Reading
|Amplify CLI Troubleshooting Guides|Description|
|-|-|
|[Amplify CLI GraphQL Troubleshooting](https://docs.amplify.aws/cli/graphql/troubleshooting/)| Troubleshoot and fix issues encountered when deploying GraphQL Schema through Amplify CLI|
|[Amplify Console Custom Domain Troubleshooting](https://docs.aws.amazon.com/amplify/latest/userguide/custom-domain-troubleshoot-guide.html)|Troubleshoot and fix issues encountered when adding Custom Domains to your Apps from the Amplify Console |
|[IAM Troubleshooting](https://docs.aws.amazon.com/amplify/latest/userguide/security_iam_troubleshoot.html)|Troubleshoot and fix common issues encountered when working with Amplify and IAM.|
|[Amplify CLI Extensibility](https://docs.amplify.aws/cli/#extensibility) | Learn about the different escape hatches provided by the Amplify CLI to extend your application and override default behavior |
|[Amplify DataStore Best Practices](https://docs.aws.amazon.com/whitepapers/latest/amplify-datastore-implementation/amplify-datastore-best-practices.html) | Learn the best practices to build your applications 'Offline First' using Amplify DataStore |
|[AWS Knowledge Center](https://aws.amazon.com/premiumsupport/knowledge-center/) | Learn about the most frequent questions and requests for your AWS services |
|[AWS Cloudformation Drift](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-stack-drift.html) | Detect and View Cloudformation Drift |
